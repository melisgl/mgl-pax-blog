<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>Global Compiler Policy</title>
<link type='text/css' href='style.css' rel='stylesheet'/>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         inlineMath: [['$','$']],
         processEscapes: true
       }
     });
   </script>
   <script type="text/javascript" async
     src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
   </script>
   <link href="https://fonts.googleapis.com/css2?family=Literata:ital,opsz,wght@0,7..72,400;0,7..72,700;1,7..72,400;1,7..72,700&display=swap" rel="stylesheet">
<style> @import url('https://fonts.googleapis.com/css2?family=Literata:ital,opsz,wght@0,7..72,400;0,7..72,700;1,7..72,400;1,7..72,700&display=swap'); </style>

</head>
<body>
<div id="content-container">
<div id="toc">
<div class="menu-block"><span class="menu-block-title">me</span><ul><li><a href="http://quotenil.com">blog</a></li><li><a href="mailto:mega@retes.hu">mega@retes.hu</a></li><li><a href="mega.gpg.asc">gpg key</a></li><li><a href="http://github.com/melisgl/">github/melisgl</a></li><li><a href="https://mastodon.social/@melisgl">mastodon.social/@melisgl</a></li><li><a href="https://twitter.com/GaborMelis">twitter/GaborMelis</a></li><li><a href="http://discord.com/users/melisgl#0879">discord/melisgl#0879</a></li><li><a href="https://www.linkedin.com/in/melisgabor/">linkedin/melisgabor</a></li></ul></div><div class="menu-block"><span class="menu-block-title">categories</span><ul><li><a href="http://quotenil.com/blog.html">all</a></li><li><a href="http://quotenil.com/category-personal.html">personal</a></li><li><a href="http://quotenil.com/category-tech.html">tech</a></li><li><a href="http://quotenil.com/category-lisp.html">lisp</a></li><li><a href="http://quotenil.com/category-ai.html">ai</a></li></ul></div><div id="page-toc">
</div>
<div id="toc-footer"><ul><li><a href="https://github.com/melisgl/mgl-pax">[generated by MGL-PAX]</a></li></ul></div>
</div>
<div id="content">
<p><a id="x-28MGL-PAX-BLOG-3A-40GLOBAL-COMPILER-POLICY-20MGL-PAX-3ASECTION-29"></a>
<a id="MGL-PAX-BLOG:@GLOBAL-COMPILER-POLICY%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#MGL-PAX-BLOG:@GLOBAL-COMPILER-POLICY%20MGL-PAX:SECTION" title="Global Compiler Policy">&#8634;</a></span></span></p>

<h1><a href="#MGL-PAX-BLOG:@GLOBAL-COMPILER-POLICY%20MGL-PAX:SECTION">Global Compiler Policy</a></h1>

<p><em>Tags</em>: <a href="lisp.html#MGL-PAX-BLOG:@LISP%20MGL-PAX:SECTION" title="Lisp">Lisp</a>, <em>Date</em>: 2009-06-30</p>

<p>A quick note to library implementors: The effects
of <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_declai.htm" title="DECLAIM MGL-PAX:MACRO"><code>DECLAIM</code></a> are <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_declai.htm" >permitted to
persist</a>
after the containing file is compiled and it is unkind to mutate
your user's settings. Personally, I find <code>DECLAIM</code> too blunt and
prefer to add declarations within functions, even going as far as
introducing <a href="http://www.lispworks.com/documentation/HyperSpec/Body/s_locall.htm" title="LOCALLY MGL-PAX:MACRO"><code>LOCALLY</code></a> subforms just to have a place on which to hang
declarations. But if you are really set on using <code>DECLAIM</code>, please
wrap it like this:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">eval-when</span></i> <span class="paren2">(<span class="code"><span class="keyword">:compile-toplevel</span></span>)</span>
 <span class="paren2">(<span class="code">declaim <span class="paren3">(<span class="code">optimize speed</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>to ensure that the body is evaluated in <a href="http://www.lispworks.com/documentation/HyperSpec/Body/03_bca.htm" >the dynamic execution
context of the
compiler</a>
which makes a practical difference on Allegro. It goes without
saying that you don't want <code>(PROCLAIM '(OPTIMIZE ...))</code> in a
library, either.</p>

<p><strong>UPDATE</strong>: The above works, but is not mandated by the spec because the
dynamic execution context of the compiler does not include the global
declarations. Alas, by the spec the portable solution is to wrap the
whole file in:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">locally</span></i> <span class="paren2">(<span class="code">declare <span class="paren3">(<span class="code">optimize speed</span>)</span></span>)</span> ...</span>)</span></span></code></pre>
  </div>
</div>
<script>$('#page-toc').toc({'selectors': 'h1'});</script>
</body>
</html>
