<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>Hung Connections
</title>
<link type='text/css' href='style.css' rel='stylesheet'>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width">
   <script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         inlineMath: [['$','$']],
         processEscapes: true
       }
     });
   </script>
   <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
   </script>
   <!-- Google tag (gtag.js) -->
<script async src='https://www.googletagmanager.com/gtag/js?id=G-7X64Q1D73F'></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7X64Q1D73F');
</script>
<script>
function padToBaselineGrid() {
  document.querySelectorAll('pre, img, #toc').forEach(el => {
    if (el.alt == 'end-of-post' || el.alt == 'about-me-die') {
      return;
    }
    // We either add a wrapper div and pad that or pad the element
    // itself.
    let padSelf = (el.id == 'toc');
    let currentHeight = el.getBoundingClientRect().height;
    if (padSelf) {
      var paddingTop = parseFloat(window.getComputedStyle(el).getPropertyValue('padding-top'));
      var paddingBottom = parseFloat(window.getComputedStyle(el).getPropertyValue('padding-bottom'));
      currentHeight -= paddingTop + paddingBottom;
    }
    let lineHeight = parseFloat(window.getComputedStyle(document.body).lineHeight);
    let targetHeight = Math.ceil(currentHeight / lineHeight) * lineHeight;
    let extraPadding = targetHeight - currentHeight;
    if (padSelf) {
      elToPad = el;
    } else {
      if (el.parentNode.className != 'padding-wrapper') {
        w = document.createElement('div');
        w.className = 'padding-wrapper';
        el.replaceWith(w);
        w.appendChild(el);
      }
      if (extraPadding < 0.75*lineHeight) {
        extraPadding += lineHeight;
      }
      elToPad = el.parentNode;
    }
    // Specify padding in rem, so that it scales with font size
    // changes.
    let remPx = parseFloat(getComputedStyle(document.documentElement).fontSize)
    extraPadding = extraPadding / 2 /remPx;
    elToPad.style.paddingTop = `${extraPadding}rem`;
    elToPad.style.paddingBottom = `${extraPadding}rem`;
  });
}
window.addEventListener('load', padToBaselineGrid);
window.addEventListener('resize', padToBaselineGrid);
</script>
<link rel='shortcut icon' type='image/png' href='favicon.png'>
<link rel='preconnect' href='https://fonts.googleapis.com'>
<link rel='preconnect' href='https://fonts.gstatic.com' crossorigin>
<link href='https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap' rel='stylesheet'>
<style> @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap'); </style>
<link rel='alternate' href='http://quotenil.com/blog.rss' type='application/rss+xml'/>

</head>
<body>
<div id="content-container">
<div id=toc>
 <div id=home>
  <a href=blog.html>(QUOTE NIL)</a>
 </div>
 <div id=links>
  Ramblings on <a href=ai.html>ai</a>, <a href=lisp.html>lisp</a>, <a
  href=tech.html>tech</a> and <a href=personal.html>personal</a> topics by <a
  href=about-me.html>me</a>.
 </div>
</div><div id="content">
<p><a id="x-28MGL-PAX-BLOG-3A-40HUNG-CONNECTIONS-20MGL-PAX-3ASECTION-29"></a>
<a id="MGL-PAX-BLOG:@HUNG-CONNECTIONS%20MGL-PAX:SECTION"></a></p>
<h1><a href="hung-connections.html">Hung Connections</a></h1>
<p><span class='post-data'><em>Tags:</em> <a href="tech.html" title="tech"><code>tech</code></a>,&nbsp; <em>Date:</em> 2011-02-27</span></p>
<div class='br'></div>
<p>My ISP replaced a Thomson modem with a Cisco
EPC3925 modem-router to fix the speed issue I was having. The good
news is that the connection operates near its advertised bandwidth,
the bad news is that tcp connections started to hang. It didn't take
long to <a href="http://hup.hu/node/98496" >find out</a> that this particular
router drops &quot;unused&quot; tcp connections after five minutes.</p>
<p>The fix recommended in the linked topic (namely <code>sysctl</code>ing
<code>net.ipv4.tcp_keepalive_time</code> &amp; co) was mostly effective, but I had
to lower the keepalive to one minute to keep my ssh sessions alive.
The trouble was that OfflineIMAP connections to the U.S. west coast
still hanged intermittently, while it could work with Gmail just
fine.</p>
<p>In the end, OfflineIMAP had to be
<a href="http://permalink.gmane.org/gmane.mail.imap.offlineimap.general/2815" >patched</a>
to use the keepalive and the keepalive be lowered to 15s:</p>
<pre><code>sysctl -w net.ipv4.tcp_keepalive_time=15 \
          net.ipv4.tcp_keepalive_intvl=15 \
          net.ipv4.tcp_keepalive_probes=20
</code></pre>
<p>Oh, and always include <code>socktimeout</code> in the OfflineIMAP config.
That's more important than keepalive unless you never have network
issues.</p>
<img src="blog-files/die.png" alt="end-of-post" />
  </div>
</div>
<script>$('#page-toc').toc({'selectors': ''});</script>
</body>
</html>
