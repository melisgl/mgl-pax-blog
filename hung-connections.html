<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>Hung Connections</title>
<link type='text/css' href='style.css' rel='stylesheet'>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width">
   <script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         inlineMath: [['$','$']],
         processEscapes: true
       }
     });
   </script>
   <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
   </script>
   <link rel='shortcut icon' type='image/png' href='favicon.png'>
<link rel='preconnect' href='https://fonts.googleapis.com'>
<link rel='preconnect' href='https://fonts.gstatic.com' crossorigin>
<link href='https://fonts.googleapis.com/css2?family=Gentium+Book+Plus:ital,wght@0,400;0,700;1,400;1,700&display=swap' rel='stylesheet'>
<style> @import url('https://fonts.googleapis.com/css2?family=Gentium+Book+Plus:ital,wght@0,400;0,700;1,400;1,700&display=swap'); </style>

</head>
<body>
<div id="content-container">
<div id=toc>
 <div id=home>
  <a href=blog.html>(QUOTE NIL)</a>
 </div>
 <div id=links>
  Ramblings on <a href=ai.html>ai</a>, <a href=lisp.html>lisp</a>, <a
  href=tech.html>tech</a> and <a href=personal.html>personal</a> topics by <a
  href=about-me.html>me</a>.
 </div>
</div><div id="content">
<p><a id="x-28MGL-PAX-BLOG-3A-40HUNG-CONNECTIONS-20MGL-PAX-3ASECTION-29"></a>
<a id="MGL-PAX-BLOG:@HUNG-CONNECTIONS%20MGL-PAX:SECTION"></a></p>

<h1><a href="hung-connections.html">Hung Connections</a></h1>

<p><em>Tags</em>: <a href="tech.html" title="tech"><code>tech</code></a>, <em>Date</em>: <code>2011-02-27</code></p>

<p>My ISP replaced a Thomson modem with a Cisco
EPC3925 modem-router to fix the speed issue I was having. The good
news is that the connection operates near its advertised bandwidth,
the bad news is that tcp connections started to hang. It didn't take
long to <a href="http://hup.hu/node/98496" >find out</a> that this particular
router drops &quot;unused&quot; tcp connections after five minutes.</p>

<p>The fix recommended in the linked topic (namely sysctl'ing
<code>net.ipv4.tcp_keepalive_time</code> &amp; co) was mostly effective but I had
to lower the keepalive to one minute to keep my ssh sessions alive.
The trouble was that OfflineIMAP connections to the U.S. west coast
still hanged intermittently while it could work with Gmail just
fine.</p>

<p>In the end, OfflineIMAP had to be
<a href="http://permalink.gmane.org/gmane.mail.imap.offlineimap.general/2815" >patched</a>
to use the keepalive and the keepalive be lowered to 15s:</p>

<pre><code>sysctl -w net.ipv4.tcp_keepalive_time=15 \
          net.ipv4.tcp_keepalive_intvl=15 \
          net.ipv4.tcp_keepalive_probes=20
</code></pre>

<p>Oh, and always include <code>socktimeout</code> in the offlineimap config, that's
more important than keepalive unless you never have network issues.</p>
  </div>
</div>
<script>$('#page-toc').toc({'selectors': ''});</script>
</body>
</html>
