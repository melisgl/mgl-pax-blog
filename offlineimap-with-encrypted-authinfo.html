<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>OfflineIMAP with Encrypted Authinfo</title>
<link type='text/css' href='style.css' rel='stylesheet'>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width">
   <script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         inlineMath: [['$','$']],
         processEscapes: true
       }
     });
   </script>
   <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
   </script>
   <!-- Google tag (gtag.js) -->
<script async src='https://www.googletagmanager.com/gtag/js?id=G-7X64Q1D73F'></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7X64Q1D73F');
</script>
<link rel='shortcut icon' type='image/png' href='favicon.png'>
<link rel='preconnect' href='https://fonts.googleapis.com'>
<link rel='preconnect' href='https://fonts.gstatic.com' crossorigin>
<link href='https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap' rel='stylesheet'>
<style> @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap'); </style>
<link href='https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,350;0,700;1,350;1,700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap' rel='stylesheet'>
<style> @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,350;0,700;1,350;1,700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap'); </style>
<link rel='alternate' href='http://quotenil.com/blog.rss' type='application/rss+xml'/>

</head>
<body>
<div id="content-container">
<div id=toc>
 <div id=home>
  <a href=blog.html>(QUOTE NIL)</a>
 </div>
 <div id=links>
  Ramblings on <a href=ai.html>ai</a>, <a href=lisp.html>lisp</a>, <a
  href=tech.html>tech</a> and <a href=personal.html>personal</a> topics by <a
  href=about-me.html>me</a>.
 </div>
</div><div id="content">
<p><a id="x-28MGL-PAX-BLOG-3A-40OFFLINEIMAP-WITH-ENCRYPTED-AUTHINFO-20MGL-PAX-3ASECTION-29"></a>
<a id="MGL-PAX-BLOG:@OFFLINEIMAP-WITH-ENCRYPTED-AUTHINFO%20MGL-PAX:SECTION"></a></p>

<h1><a href="offlineimap-with-encrypted-authinfo.html">OfflineIMAP with Encrypted Authinfo</a></h1>

<p><span class='post-data'><em>Tags</em>: <a href="tech.html" title="tech"><code>tech</code></a>, <em>Date</em>: <code>2011-02-26</code></span></p>

<p>I've moved to an
<a href="http://offlineimap.org/" >OfflineIMAP</a> + <a href="http://gnus.org/" >Gnus</a>
setup that's outlined at
<a href="http://sachachua.com/blog/2008/05/geek-how-to-use-offlineimap-and-the-dovecot-mail-server-to-read-your-gmail-in-emacs-efficiently/" >various</a>
<a href="http://nakkaya.com/2010/04/10/using-offlineimap-with-gnus/" >places</a>.
Gnus can be configured to use
<a href="http://www.emacswiki.org/emacs-en/GnusAuthinfo" >~/.authinfo</a> as a
netrc style of file to read passwords from and can easily use
<a href="http://www.emacswiki.org/emacs-en/GnusEncryptedAuthInfo" >encrypted
authinfo</a>
files as well. Offlineimap, on the other hand, offers no such
support and passwords to the local and remote imap accounts are
normally stored in clear text in <code>.offlineimaprc</code>.</p>

<p>For the local account this can be overcome by not running a dovecot
server but making offlineimap spawn a dovecot process when needed:</p>

<pre><code>[Repository LocalGmail]
type = IMAP
preauthtunnel = /usr/sbin/dovecot -c ~/.dovecot.conf --exec-mail imap
</code></pre>

<p>For the remote connection, ideally it should read the password from
<code>.authinfo.gpg</code> that Gnus may also read if it's configured to access
the remote server directly. This can be pulled off rather easily.
Add an /include/ to <code>.offlineimaprc</code> like this:</p>

<pre><code>[general]
pythonfile = ~/.offlineimap.py
</code></pre>

<p>where <code>~/.offlineimap.py</code> just defines a single function called
<code>get_authinfo_password</code>:</p>

<pre><code>#!/usr/bin/python
import re, os

def get_authinfo_password(machine, login, port):
    s = &quot;machine %s login %s password ([^ ]*) port %s&quot; % (machine, login, port)
    p = re.compile(s)
    authinfo = os.popen(&quot;gpg -q --no-tty -d ~/.authinfo.gpg&quot;).read()
    return p.search(authinfo).group(1)
</code></pre>

<p>Now, all that's left is to change remotepass to something like this:</p>

<pre><code>remotepasseval = get_authinfo_password(&quot;imap.gmail.com&quot;, &quot;username@gmail.com&quot;, 993)
</code></pre>

<p>Of course, <code>.authinfo.gpg</code> should also have the corresponding entry:</p>

<pre><code>machine imap.gmail.com login username@gmail.com password &lt;password&gt; port 993
</code></pre>

<p>That's it, no more cleartext passwords.</p>
  </div>
</div>
<script>$('#page-toc').toc({'selectors': ''});</script>
</body>
</html>
