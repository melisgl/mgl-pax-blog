<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>OfflineIMAP with Encrypted Authinfo</title>
<link type='text/css' href='style.css' rel='stylesheet'/>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         inlineMath: [['$','$']],
         processEscapes: true
       }
     });
   </script>
   <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
   </script>
   </head>
<body>
<div id="content-container">
<div id="toc">
<div class="menu-block"><span class="menu-block-title">me</span><ul><li><a href="http://quotenil.com">blog</a></li><li><a href="mailto:mega@retes.hu">email</a></li><li><a href="mega.gpg.asc">gpg key</a></li><li><a href="cv/cv-eng.pdf">cv (english)</a></li><li><a href="cv/cv-hun.pdf">cv (hungarian)</a></li><li><a href="http://github.com/melisgl/">git</a></li></ul></div><div class="menu-block"><span class="menu-block-title">categories</span><ul><li><a href="http://quotenil.com/blog.html">all</a></li><li><a href="http://quotenil.com/category-personal.html">personal</a></li><li><a href="http://quotenil.com/category-tech.html">tech</a></li><li><a href="http://quotenil.com/category-lisp.html">lisp</a></li><li><a href="http://quotenil.com/category-ai.html">ai</a></li></ul></div><div id="page-toc">
</div>
<div id="toc-footer"><ul><li><a href="https://github.com/melisgl/mgl-pax">[generated by MGL-PAX]</a></li></ul></div>
</div>
<div id="content">
<p><a id='x-28MGL-PAX-BLOG-3A-40OFFLINEIMAP-WITH-ENCRYPTED-AUTHINFO-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28MGL-PAX-BLOG-3A-40OFFLINEIMAP-WITH-ENCRYPTED-AUTHINFO-20MGL-PAX-3ASECTION-29" title="OfflineIMAP with Encrypted Authinfo">&#8634;</a></span></span></p>

<h1><a href="#x-28MGL-PAX-BLOG-3A-40OFFLINEIMAP-WITH-ENCRYPTED-AUTHINFO-20MGL-PAX-3ASECTION-29">OfflineIMAP with Encrypted Authinfo</a></h1>

<p><em>Tags</em>: <a href="category-tech.html#x-28MGL-PAX-BLOG-3A-3A-40CATEGORY-TECH-20MGL-PAX-3ASECTION-29" title="Tech">Tech</a>, <a href="blog.html#x-28MGL-PAX-BLOG-3A-3A-40BLOG-20MGL-PAX-3ASECTION-29" title="Blog">Blog</a></p>

<p><em>2011-02-26</em> -- I've moved to an
<a href="http://offlineimap.org/" >OfflineIMAP</a> + <a href="http://gnus.org/" >Gnus</a>
setup that's outlined at
<a href="http://sachachua.com/blog/2008/05/geek-how-to-use-offlineimap-and-the-dovecot-mail-server-to-read-your-gmail-in-emacs-efficiently/" >various</a>
<a href="http://nakkaya.com/2010/04/10/using-offlineimap-with-gnus/" >places</a>.
Gnus can be configured to use
<a href="http://www.emacswiki.org/emacs-en/GnusAuthinfo" >~/.authinfo</a> as a
netrc style of file to read passwords from and can easily use
<a href="http://www.emacswiki.org/emacs-en/GnusEncryptedAuthInfo" >encrypted
authinfo</a>
files as well. Offlineimap, on the other hand, offers no such
support and passwords to the local and remote imap accounts are
normally stored in clear text in <code>.offlineimaprc</code>.</p>

<p>For the local account this can be overcome by not running a dovecot
server but making offlineimap spawn a dovecot process when needed:</p>

<pre><code>[Repository LocalGmail]
type = IMAP
preauthtunnel = /usr/sbin/dovecot -c ~/.dovecot.conf --exec-mail imap
</code></pre>

<p>For the remote connection, ideally it should read the password from
<code>.authinfo.gpg</code> that Gnus may also read if it's configured to access
the remote server directly. This can be pulled off rather easily.
Add an /include/ to <code>.offlineimaprc</code> like this:</p>

<pre><code>[general]
pythonfile = ~/.offlineimap.py
</code></pre>

<p>where <code>~/.offlineimap.py</code> just defines a single function called
<code>get_authinfo_password</code>:</p>

<pre><code>#!/usr/bin/python
import re, os

def get_authinfo_password(machine, login, port):
    s = &quot;machine %s login %s password ([^ ]*) port %s&quot; % (machine, login, port)
    p = re.compile(s)
    authinfo = os.popen(&quot;gpg -q --no-tty -d ~/.authinfo.gpg&quot;).read()
    return p.search(authinfo).group(1)
</code></pre>

<p>Now, all that's left is to change remotepass to something like this:</p>

<pre><code>remotepasseval = get_authinfo_password(&quot;imap.gmail.com&quot;, &quot;username@gmail.com&quot;, 993)
</code></pre>

<p>Of course, <code>.authinfo.gpg</code> should also have the corresponding entry:</p>

<pre><code>machine imap.gmail.com login username@gmail.com password &lt;password&gt; port 993
</code></pre>

<p>That's it, no more cleartext passwords.</p>
  </div>
</div>
<script>$('#page-toc').toc({'selectors': 'h1'});</script>
</body>
</html>
