<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>Journal, the kitchen sink</title>
<link type='text/css' href='style.css' rel='stylesheet'/>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         inlineMath: [['$','$']],
         processEscapes: true
       }
     });
   </script>
   <script type="text/javascript" async
     src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
   </script>
   <link href="https://fonts.googleapis.com/css2?family=Literata:ital,opsz,wght@0,7..72,400;0,7..72,700;1,7..72,400;1,7..72,700&display=swap" rel="stylesheet">
<style> @import url('https://fonts.googleapis.com/css2?family=Literata:ital,opsz,wght@0,7..72,400;0,7..72,700;1,7..72,400;1,7..72,700&display=swap'); </style>

</head>
<body>
<div id="content-container">
<div id="toc">
<div class="menu-block"><span class="menu-block-title">Blog Categories</span><ul><li><a href="http://quotenil.com">'() blog</a></li><li><a href="http://quotenil.com/category-lisp.html">lisp</a></li><li><a href="http://quotenil.com/category-ai.html">ai</a></li><li><a href="http://quotenil.com/category-tech.html">tech</a></li><li><a href="http://quotenil.com/category-personal.html">personal</a></li></ul></div><div class="menu-block"><span class="menu-block-title">Me</span><ul><li><a href="mailto:mega@retes.hu">mega@retes.hu</a></li><li><a href="mega.gpg.asc">gpg key</a></li><li><a href="http://github.com/melisgl/">github/melisgl</a></li><li><a href="https://mastodon.social/@melisgl">mastodon.social/@melisgl</a></li><li><a href="https://twitter.com/GaborMelis">twitter/GaborMelis</a></li><li><a href="http://discord.com/users/melisgl#0879">discord/melisgl#0879</a></li><li><a href="https://www.linkedin.com/in/melisgabor/">linkedin/melisgabor</a></li></ul></div><div id="page-toc">
</div>
<div id="toc-footer"><ul><li><a href="https://github.com/melisgl/mgl-pax">[generated by MGL-PAX]</a></li></ul></div>
</div>
<div id="content">
<p><a id="x-28MGL-PAX-BLOG-3A-40JOURNAL-THE-KITCHEN-SINK-20MGL-PAX-3ASECTION-29"></a>
<a id="MGL-PAX-BLOG:@JOURNAL-THE-KITCHEN-SINK%20MGL-PAX:SECTION"></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="journal-the-kitchen-sink.html" title="Journal, the kitchen sink">&#8634;</a></span></span></p>

<h1><a href="journal-the-kitchen-sink.html" title="Journal, the kitchen sink">Journal, the kitchen sink</a></h1>

<p><em>Tags</em>: <a href="lisp.html" title="Lisp">Lisp</a>, <em>Date</em>: 2020-09-04</p>

<p>Ever wished for machine-readable logs and <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_tracec.htm" ><code>TRACE</code></a>s, maybe
for writing tests or something more fancy? The
<a href="http://melisgl.github.io/mgl-pax-world/journal-manual.html#x-28JOURNAL-3A-40JOURNAL-BACKGROUND-20MGL-PAX-3ASECTION-29" >Journal</a> library takes a simple idea:
user-defined execution traces, and implements
<a href="http://melisgl.github.io/mgl-pax-world/journal-manual.html#x-28JOURNAL-3A-40LOGGING-20MGL-PAX-3ASECTION-29" >logging</a>, <a href="http://melisgl.github.io/mgl-pax-world/journal-manual.html#x-28JOURNAL-3A-40TRACING-20MGL-PAX-3ASECTION-29" >tracing</a>, a
<a href="http://melisgl.github.io/mgl-pax-world/journal-manual.html#x-28JOURNAL-3A-40TESTING-20MGL-PAX-3ASECTION-29" >testing</a> &quot;framework&quot; with <a href="https://en.wikipedia.org/wiki/Mock_object" >mock</a>
support, and an <a href="https://martinfowler.com/eaaDev/EventSourcing.html" >Event Sourcing</a> style
<a href="http://melisgl.github.io/mgl-pax-world/journal-manual.html#x-28JOURNAL-3A-40PERSISTENCE-20MGL-PAX-3ASECTION-29" >database</a> on top.</p>

<p>Perhaps the highlight from the linked tutorials is how easy
persistence is. Let's write a simple game:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> play-guess-my-number <span class="paren2">(<span class="code"></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">my-number <span class="paren5">(<span class="code">random 10</span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code">format t <span class="string">"~%I thought of a number.~%"</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">loop</span></i> for i upfrom 0 do
      <span class="paren4">(<span class="code">write-line <span class="string">"Guess my number:"</span></span>)</span>
      <span class="paren4">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren5">(<span class="code"><span class="paren6">(<span class="code">guess <span class="paren1">(<span class="code">values <span class="paren2">(<span class="code">parse-integer <span class="paren3">(<span class="code">read-line</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
        <span class="paren5">(<span class="code">format t <span class="string">"You guessed ~D.~%"</span> guess</span>)</span>
        <span class="paren5">(<span class="code">when <span class="paren6">(<span class="code">= guess my-number</span>)</span>
          <span class="paren6">(<span class="code">format t <span class="string">"You guessed it in ~D tries!"</span> <span class="paren1">(<span class="code">1+ i</span>)</span></span>)</span>
          <span class="paren6">(<span class="code">return</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>That came out pretty ugly, didn't it? Now, suppose we want to turn
this into a browser game so:</p>

<ul>
<li><p>the state of the game must be saved,</p></li>
<li><p>and the game shall be resumed from the last saved state,</p></li>
<li><p>even if the web server's worker thread times out, or there is a
  power failure.</p></li>
</ul>

<p>So these are the requirements apart from adding the webby stuff,
which I'm not going to bore you with. To implement them, we wrap
<code>REPLAYED</code> around <em>external interactions</em>, <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_random.htm" title="RANDOM FUNCTION"><code>RANDOM</code></a> and <a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_rd_lin.htm" title="READ-LINE FUNCTION"><code>READ-LINE</code></a>:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> play-guess-my-number <span class="paren2">(<span class="code"></span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">my-number <span class="paren5">(<span class="code">replayed <span class="paren6">(<span class="code">think-of-a-number</span>)</span> <span class="comment">; &lt;- HERE
</span>                     <span class="paren6">(<span class="code">random 10</span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code">format t <span class="string">"~%I thought of a number.~%"</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">loop</span></i> for i upfrom 0 do
      <span class="paren4">(<span class="code">write-line <span class="string">"Guess my number:"</span></span>)</span>
      <span class="paren4">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren5">(<span class="code"><span class="paren6">(<span class="code">guess <span class="paren1">(<span class="code">replayed <span class="paren2">(<span class="code">read-guess</span>)</span>        <span class="comment">; &lt;- HERE
</span>                     <span class="paren2">(<span class="code">values <span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">read-line</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
        <span class="paren5">(<span class="code">format t <span class="string">"You guessed ~D.~%"</span> guess</span>)</span>
        <span class="paren5">(<span class="code">when <span class="paren6">(<span class="code">= guess my-number</span>)</span>
          <span class="paren6">(<span class="code">format t <span class="string">"You guessed it in ~D tries!"</span> <span class="paren1">(<span class="code">1+ i</span>)</span></span>)</span>
          <span class="paren6">(<span class="code">return</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>Now, we need to say where to store the event journal:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-bundle</span></i> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">make-file-bundle <span class="string">"/tmp/guess-my-number/"</span> <span class="keyword">:sync</span> t</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">play-guess-my-number</span>)</span></span>)</span></span></code></pre>

<p>This is invoked from the web server's worker and it replays the game
until it was interrupted last time around. Then it will block
waiting for user input in <code>READ-LINE</code> or, if the game is finished,
return.</p>

<p>Note the <code>:SYNC T</code>, which tells Journal to take durability seriously.</p>

<p>You can find the code <a href="https://github.com/melisgl/journal" >here</a>.</p>
  </div>
</div>
<script>$('#page-toc').toc({'selectors': 'h1'});</script>
</body>
</html>
