<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>Object Initialization with Slot Dependencies</title>
<link type='text/css' href='style.css' rel='stylesheet'/>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         inlineMath: [['$','$']],
         processEscapes: true
       }
     });
   </script>
   <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
   </script>
   </head>
<body>
<div id="content-container">
<div id="toc">
<div class="menu-block"><span class="menu-block-title">me</span><ul><li><a href="http://quotenil.com">blog</a></li><li><a href="mailto:mega@retes.hu">email</a></li><li><a href="mega.gpg.asc">gpg key</a></li><li><a href="cv/cv-eng.pdf">cv (english)</a></li><li><a href="cv/cv-hun.pdf">cv (hungarian)</a></li><li><a href="http://github.com/melisgl/">git</a></li></ul></div><div class="menu-block"><span class="menu-block-title">categories</span><ul><li><a href="http://quotenil.com/blog.html">all</a></li><li><a href="http://quotenil.com/category-personal.html">personal</a></li><li><a href="http://quotenil.com/category-tech.html">tech</a></li><li><a href="http://quotenil.com/category-lisp.html">lisp</a></li><li><a href="http://quotenil.com/category-ai.html">ai</a></li></ul></div><div id="page-toc">
</div>
<div id="toc-footer"><ul><li><a href="https://github.com/melisgl/mgl-pax">[generated by MGL-PAX]</a></li></ul></div>
</div>
<div id="content">
<p><a id='x-28MGL-PAX-BLOG-3A-40OBJECT-INITIALIZATION-WITH-SLOT-DEPENDENCIES-20MGL-PAX-3ASECTION-29'></a></p>

<p><span class="outer-navigation"><span class="navigation"> <a href="#x-28MGL-PAX-BLOG-3A-40OBJECT-INITIALIZATION-WITH-SLOT-DEPENDENCIES-20MGL-PAX-3ASECTION-29" title="Object Initialization with Slot Dependencies">&#8634;</a></span></span></p>

<h1><a href="#x-28MGL-PAX-BLOG-3A-40OBJECT-INITIALIZATION-WITH-SLOT-DEPENDENCIES-20MGL-PAX-3ASECTION-29">Object Initialization with Slot Dependencies</a></h1>

<p><em>Tags</em>: <a href="category-lisp.html#x-28MGL-PAX-BLOG-3A-3A-40CATEGORY-LISP-20MGL-PAX-3ASECTION-29" title="Lisp">Lisp</a>, <a href="blog.html#x-28MGL-PAX-BLOG-3A-3A-40BLOG-20MGL-PAX-3ASECTION-29" title="Blog">Blog</a></p>

<p><em>2009-07-04</em> -- Consider a class with a trivial initialization
dependency between slots <code>A</code> and <code>B</code>:))</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defclass</span></i> super <span class="paren2">(<span class="code"></span>)</span>
 <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">a <span class="keyword">:initarg</span> <span class="keyword">:a</span> <span class="keyword">:reader</span> a</span>)</span>
  <span class="paren3">(<span class="code">b <span class="keyword">:initform</span> 0 <span class="keyword">:initarg</span> <span class="keyword">:b</span> <span class="keyword">:reader</span> b</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defmethod</span></i> initialize-instance <span class="keyword">:after</span> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">super super</span>)</span> &amp;key &amp;allow-other-keys</span>)</span>
 <span class="paren2">(<span class="code">setf <span class="paren3">(<span class="code">slot-value super 'a</span>)</span> <span class="paren3">(<span class="code">1+ <span class="paren4">(<span class="code">slot-value super 'b</span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code">a <span class="paren2">(<span class="code">make-instance 'super</span>)</span></span>)</span> =&gt; 1
<span class="paren1">(<span class="code">a <span class="paren2">(<span class="code">make-instance 'super <span class="keyword">:b</span> 1</span>)</span></span>)</span> =&gt; 2</span></code></pre>

<p>You may even subclass it, add an initform and it still works:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defclass</span></i> sub <span class="paren2">(<span class="code">super</span>)</span>
 <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">b <span class="keyword">:initform</span> 1</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code">a <span class="paren2">(<span class="code">make-instance 'sub</span>)</span></span>)</span> =&gt; 2</span></code></pre>

<p>The complication begins when a subclass adds another slot, <code>C</code>, from
which <code>B</code> is to be computed:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defclass</span></i> sub2 <span class="paren2">(<span class="code">super</span>)</span>
 <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">c <span class="keyword">:initarg</span> <span class="keyword">:c</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>Say, <code>B</code> is to be initialized to <code>C + 1</code>. That's easy, let's just add
a after method, but the after method of the subclass runs after the
after method of the superclass, hence the value of <code>A</code> is wrong:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defmethod</span></i> initialize-instance <span class="keyword">:after</span> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">sub2 sub2</span>)</span> &amp;key c &amp;allow-other-keys</span>)</span>
 <span class="paren2">(<span class="code">setf <span class="paren3">(<span class="code">slot-value sub2 'b</span>)</span> <span class="paren3">(<span class="code">1+ c</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code">a <span class="paren2">(<span class="code">make-instance 'sub2 <span class="keyword">:c</span> 1</span>)</span></span>)</span> =&gt; 1</span></code></pre>

<p>Sure, it should be a before method. And the previous example is now fixed:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defmethod</span></i> initialize-instance <span class="keyword">:before</span> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">sub2 sub2</span>)</span> &amp;key c &amp;allow-other-keys</span>)</span>
 <span class="paren2">(<span class="code">setf <span class="paren3">(<span class="code">slot-value sub2 'b</span>)</span> <span class="paren3">(<span class="code">1+ c</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code">a <span class="paren2">(<span class="code">make-instance 'sub2 <span class="keyword">:c</span> 1</span>)</span></span>)</span> =&gt; 3</span></code></pre>

<p>However, it doesn't work if <code>SUB2</code> or a subclass of it has an initform
on <code>C</code>:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defclass</span></i> sub3 <span class="paren2">(<span class="code">sub2</span>)</span>
 <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">c <span class="keyword">:initform</span> 2 <span class="keyword">:initarg</span> <span class="keyword">:c</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code">a <span class="paren2">(<span class="code">make-instance 'sub3</span>)</span></span>)</span> =&gt; error</span></code></pre>

<p>because <code>C</code> is not passed as an initarg for which the before method is
unprepared. At this point one can say screw initforms and use
<code>DEFAULT-INITARGS</code> but that's fragile in face of unsuspecting
subclasses breaking this convention. Alternatively, one can initialize
C early which handles both initforms and initargs fine:</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defclass</span></i> sub4 <span class="paren2">(<span class="code">super</span>)</span>
 <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">c <span class="keyword">:initform</span> 2 <span class="keyword">:initarg</span> <span class="keyword">:c</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defmethod</span></i> initialize-instance <span class="keyword">:around</span> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">sub4 sub4</span>)</span> &amp;rest initargs
                                       &amp;key &amp;allow-other-keys</span>)</span>
 <span class="paren2">(<span class="code">apply #'shared-initialize sub4 '<span class="paren3">(<span class="code">c</span>)</span> initargs</span>)</span>
 <span class="paren2">(<span class="code">apply #'call-next-method sub4 <span class="keyword">:b</span> <span class="paren3">(<span class="code">1+ <span class="paren4">(<span class="code">slot-value sub4 'c</span>)</span></span>)</span> initargs</span>)</span></span>)</span>

<span class="paren1">(<span class="code">a <span class="paren2">(<span class="code">make-instance 'sub4</span>)</span></span>)</span> =&gt; 4
<span class="paren1">(<span class="code">a <span class="paren2">(<span class="code">make-instance 'sub4 <span class="keyword">:c</span> 10</span>)</span></span>)</span> =&gt; 12</span></code></pre>

<p>That's the best I could come up with, educate me if you have a
better idea.</p>

<p><em>UPDATE</em>: Lazy initialiation has been suggested as an alternative.
However, a naive implementation based on <code>SLOT-BOUND-P</code> is bound to
run into problems when the lazily computed slot has an initform in a
superclass. With <code>SLOT-VALUE-USING-CLASS</code> one can probably mimick
most of the semantics here in a very clean manner but to avoid
recomputing the value on every access additional bookkeeping is
needed, again, due to initforms.</p>
  </div>
</div>
<script>$('#page-toc').toc({'selectors': 'h1'});</script>
</body>
</html>
